# TODO: Задачи для модуля аналитики кредитов

Этот документ описывает план работ по созданию и развитию сервиса аналитики кредитного портфеля.

## 1. Базовая аналитика портфеля

### 1.1. Расчет общего портфеля активных кредитов
-   [ ] **Создать RPC-метод `GetTotalActiveLoanPortfolio`**.
    -   [ ] Определить `TotalActiveLoanPortfolioResponse` для возврата общей суммы.
-   [ ] **Реализовать сервисную логику:**
    -   [ ] Получить все кредиты из базы данных.
    -   [ ] Отфильтровать кредиты со статусом "активный".
    -   [ ] Просуммировать оставшуюся основную сумму долга по отфильтрованным кредитам.
    -   [ ] Вернуть итоговую сумму.

### 1.2. Анализ распределения кредитов по статусам
-   [ ] **Создать RPC-метод `GetLoanDistributionByStatus`**.
    -   [ ] Определить `LoanDistributionByStatusResponse` для возврата карты `статус -> количество`.
-   [ ] **Реализовать сервисную логику:**
    -   [ ] Сгруппировать все кредиты по полю `status`.
    -   [ ] Подсчитать количество кредитов в каждой группе.
    -   [ ] Вернуть результат в виде словаря (map).

### 1.3. Расчет средней процентной ставки
-   [ ] **Создать RPC-метод `GetAverageLoanInterestRate`**.
    -   [ ] Определить `AverageLoanInterestRateResponse` для возврата среднего значения.
-   [ ] **Реализовать сервисную логику:**
    -   [ ] Определить методику расчета (простое среднее или средневзвешенное по сумме кредита). **Предпочтительно использовать средневзвешенное.**
    -   [ ] Получить все активные кредиты.
    -   [ ] Рассчитать средневзвешенную ставку по формуле: `SUM(loan_amount * interest_rate) / SUM(loan_amount)`.
    -   [ ] Вернуть полученное значение.

## 2. Продвинутая аналитика и прогнозирование

### 2.1. Прогнозирование рисков невозврата (Кредитный скоринг)
-   [ ] **Подготовительный этап (Data Science):**
    -   [ ] Определить признаки (features) для модели: данные о клиенте (возраст, доход), история транзакций, параметры кредита (сумма, срок).
    -   [ ] Собрать и подготовить исторические данные для обучения (разметить дефолтные и успешные кредиты).
    -   [ ] Выбрать и обучить модель машинного обучения (например, логистическая регрессия или градиентный бустинг).
    -   [ ] Сохранить обученную модель (например, в формате `.pkl` или `ONNX`).
-   [ ] **Интеграция модели в сервис:**
    -   [ ] **Создать RPC-метод `PredictLoanDefaultRisk`**.
        -   [ ] Определить `PredictLoanDefaultRiskRequest` (принимает `loan_id` или данные для скоринга).
        -   [ ] Определить `PredictLoanDefaultRiskResponse` (возвращает оценку риска, например, от 0.0 до 1.0).
    -   [ ] **Реализовать сервисную логику:**
        -   [ ] Загрузить обученную модель.
        -   [ ] По запросу собирать необходимые признаки для указанного кредита/клиента.
        -   [ ] Передавать признаки в модель и получать предсказание.
        -   [ ] Возвращать оценку риска.

### 2.2. Сегментация кредитного портфеля
-   [ ] **Создать RPC-метод `GetLoanPortfolioSegmentation`**.
    -   [ ] Определить `GetLoanPortfolioSegmentationRequest` с `enum SegmentationType` (например, `BY_CUSTOMER_TYPE`, `BY_TERM`, `BY_AMOUNT`).
    -   [ ] Определить `GetLoanPortfolioSegmentationResponse`, который будет возвращать список сегментов, где каждый сегмент содержит имя и список кредитов.
-   [ ] **Реализовать сервисную логику:**
    -   [ ] В зависимости от типа сегментации в запросе, реализовать логику группировки.
    -   [ ] **Сегментация по срокам:** сгруппировать кредиты по категориям (краткосрочные, среднесрочные, долгосрочные).
    -   [ ] **Сегментация по типу клиента:** сгруппировать кредиты по типу заемщика (физ. лицо, юр. лицо, VIP).
    -   [ ] Вернуть структурированный ответ с сегментированными данными.

## 3. Отчетность и мониторинг

### 3.1. Создание периодических отчетов
-   [ ] **Разработать внутренний механизм (планировщик):**
    -   [ ] Настроить ежедневный/еженедельный запуск аналитических задач.
    -   [ ] Сохранять ключевые метрики (общий портфель, распределение по статусам) в отдельную таблицу для отслеживания динамики.
-   [ ] **Создать RPC-метод для получения исторических данных**
    -   [ ] **Создать метод `GetPortfolioHistory`**, принимающий диапазон дат.
    -   [ ] Реализовать логику для извлечения сохраненных метрик за указанный период.
